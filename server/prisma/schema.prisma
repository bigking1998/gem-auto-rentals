// Prisma Schema for Gem Auto Rentals

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User model - customers and staff
model User {
  id                 String     @id @default(cuid())
  email              String     @unique
  password           String
  firstName          String
  lastName           String
  phone              String?
  role               Role       @default(CUSTOMER)
  emailVerified      Boolean    @default(false)
  avatarUrl          String?
  resetToken         String?    @unique
  resetTokenExpiry   DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Core relations
  bookings      Booking[]
  documents     Document[]
  reviews       Review[]

  // CRM Feature relations
  preferences           UserPreferences?
  sessions              Session[]
  activityLogs          ActivityLog[]
  notifications         Notification[]
  invoices              Invoice[]

  // Conversations
  customerConversations Conversation[] @relation("CustomerConversations")
  assignedConversations Conversation[] @relation("AssignedConversations")
  sentMessages          Message[]
}

enum Role {
  CUSTOMER
  SUPPORT
  MANAGER
  ADMIN
}

// Vehicle model - fleet inventory
model Vehicle {
  id           String          @id @default(cuid())
  make         String
  model        String
  year         Int
  category     VehicleCategory
  dailyRate    Decimal         @db.Decimal(10, 2)
  status       VehicleStatus   @default(AVAILABLE)
  images       String[]
  features     String[]
  description  String?
  seats        Int
  doors        Int             @default(4)
  transmission Transmission
  fuelType     FuelType
  mileage      Int
  color        String?
  licensePlate String          @unique
  vin          String          @unique
  location     String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  bookings     Booking[]
  reviews      Review[]
  maintenance  MaintenanceRecord[]
}

enum VehicleCategory {
  ECONOMY
  STANDARD
  PREMIUM
  LUXURY
  SUV
  VAN
}

enum VehicleStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
  RETIRED
}

enum Transmission {
  AUTOMATIC
  MANUAL
}

enum FuelType {
  GASOLINE
  DIESEL
  ELECTRIC
  HYBRID
}

// Booking model - rental reservations
model Booking {
  id              String        @id @default(cuid())
  userId          String
  vehicleId       String
  startDate       DateTime
  endDate         DateTime
  status          BookingStatus @default(PENDING)
  totalAmount     Decimal       @db.Decimal(10, 2)
  dailyRate       Decimal       @db.Decimal(10, 2)
  extras          Json?         // insurance, gps, child seat, etc.
  pickupLocation  String
  dropoffLocation String
  notes           String?
  contractSigned  Boolean       @default(false)
  contractUrl     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id])
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id])
  payment         Payment?

  // CRM relations
  conversations   Conversation[]
  invoices        Invoice[]

  @@index([userId])
  @@index([vehicleId])
  @@index([status])
  @@index([startDate, endDate])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  ACTIVE
  COMPLETED
  CANCELLED
}

// Payment model - transaction records
model Payment {
  id                    String        @id @default(cuid())
  bookingId             String        @unique
  amount                Decimal       @db.Decimal(10, 2)
  status                PaymentStatus @default(PENDING)
  stripePaymentIntentId String?
  stripeChargeId        String?
  method                PaymentMethod?
  refundAmount          Decimal?      @db.Decimal(10, 2)
  refundReason          String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  booking               Booking       @relation(fields: [bookingId], references: [id])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  CASH
  CHECK
  WIRE
}

// Document model - customer documents
model Document {
  id          String         @id @default(cuid())
  userId      String
  bookingId   String?
  type        DocumentType
  fileName    String
  fileUrl     String         // Storage path in Supabase
  fileSize    Int            // File size in bytes
  mimeType    String
  status      DocumentStatus @default(PENDING)
  verifiedAt  DateTime?
  verifiedBy  String?
  expiresAt   DateTime?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user        User           @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([bookingId])
  @@index([type])
  @@index([status])
}

enum DocumentType {
  DRIVERS_LICENSE_FRONT
  DRIVERS_LICENSE_BACK
  ID_CARD
  PASSPORT
  PROOF_OF_ADDRESS
  INSURANCE
}

enum DocumentStatus {
  PENDING
  VERIFIED
  REJECTED
}

// Review model - vehicle reviews
model Review {
  id        String   @id @default(cuid())
  userId    String
  vehicleId String
  rating    Int      @db.SmallInt // 1-5
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id])

  @@unique([userId, vehicleId])
  @@index([vehicleId])
}

// Maintenance records for vehicles
model MaintenanceRecord {
  id          String   @id @default(cuid())
  vehicleId   String
  type        String   // Oil change, tire rotation, inspection, etc.
  description String?
  cost        Decimal? @db.Decimal(10, 2)
  performedAt DateTime
  nextDueAt   DateTime?
  mileageAt   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vehicle     Vehicle  @relation(fields: [vehicleId], references: [id])

  @@index([vehicleId])
}

// =============================================
// CRM FEATURES - Admin Dashboard Implementation
// =============================================

// Phase 1: Messages & Communications System
// -----------------------------------------

model Conversation {
  id            String             @id @default(cuid())

  // Participants
  customerId    String
  customer      User               @relation("CustomerConversations", fields: [customerId], references: [id])

  // Metadata
  subject       String?
  status        ConversationStatus @default(OPEN)
  priority      Priority           @default(NORMAL)

  // Assignment
  assignedToId  String?
  assignedTo    User?              @relation("AssignedConversations", fields: [assignedToId], references: [id])

  // Related entities (optional)
  bookingId     String?
  booking       Booking?           @relation(fields: [bookingId], references: [id])

  // Timestamps
  lastMessageAt DateTime           @default(now())
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  // Relations
  messages      Message[]

  @@index([customerId])
  @@index([assignedToId])
  @@index([status])
  @@index([lastMessageAt])
}

model Message {
  id              String             @id @default(cuid())

  conversationId  String
  conversation    Conversation       @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Sender
  senderId        String
  sender          User               @relation(fields: [senderId], references: [id])
  senderType      SenderType

  // Content
  content         String             @db.Text
  contentType     MessageContentType @default(TEXT)

  // Attachments
  attachments     MessageAttachment[]

  // Status
  readAt          DateTime?

  // Email tracking (if sent via email)
  emailMessageId  String?

  createdAt       DateTime           @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model MessageAttachment {
  id          String   @id @default(cuid())
  messageId   String
  message     Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)

  fileName    String
  fileUrl     String
  fileSize    Int
  mimeType    String

  createdAt   DateTime @default(now())

  @@index([messageId])
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SenderType {
  CUSTOMER
  STAFF
  SYSTEM
}

enum MessageContentType {
  TEXT
  HTML
  TEMPLATE
}

// Phase 2: Security & Session Management
// --------------------------------------

model Session {
  id            String    @id @default(cuid())

  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session info
  token         String    @unique

  // Device/location info
  userAgent     String?
  ipAddress     String?
  device        String?
  browser       String?
  os            String?
  location      String?

  // Status
  isActive      Boolean   @default(true)
  lastActiveAt  DateTime  @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?
  revokedReason String?

  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([isActive])
  @@index([lastActiveAt])
}

model ActivityLog {
  id          String         @id @default(cuid())

  // Actor
  userId      String?
  user        User?          @relation(fields: [userId], references: [id])

  // Action details
  action      ActivityAction
  entityType  String?
  entityId    String?

  // Context
  description String
  metadata    Json?

  // Request info
  ipAddress   String?
  userAgent   String?

  // Status
  status      ActivityStatus @default(SUCCESS)
  errorMessage String?

  createdAt   DateTime       @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum ActivityAction {
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGE
  PASSWORD_RESET
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED

  // Users
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  ROLE_CHANGE

  // Vehicles
  VEHICLE_CREATE
  VEHICLE_UPDATE
  VEHICLE_DELETE
  VEHICLE_STATUS_CHANGE

  // Bookings
  BOOKING_CREATE
  BOOKING_UPDATE
  BOOKING_CANCEL
  BOOKING_STATUS_CHANGE
  CONTRACT_UPLOAD

  // Payments
  PAYMENT_PROCESS
  PAYMENT_REFUND

  // Documents
  DOCUMENT_UPLOAD
  DOCUMENT_VERIFY
  DOCUMENT_REJECT

  // Messages
  CONVERSATION_CREATE
  MESSAGE_SEND

  // Settings
  SETTINGS_UPDATE
}

enum ActivityStatus {
  SUCCESS
  FAILURE
  PENDING
}

// Phase 3: Settings Completion
// ----------------------------

model UserPreferences {
  id                    String   @id @default(cuid())

  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Email notifications
  emailBookingConfirm   Boolean  @default(true)
  emailBookingReminder  Boolean  @default(true)
  emailPaymentReceipt   Boolean  @default(true)
  emailPromotions       Boolean  @default(false)
  emailNewsletter       Boolean  @default(false)

  // Push notifications (future)
  pushEnabled           Boolean  @default(false)

  // SMS notifications
  smsBookingReminder    Boolean  @default(false)
  smsPaymentAlert       Boolean  @default(false)

  // Preferences
  language              String   @default("en")
  timezone              String   @default("America/New_York")
  dateFormat            String   @default("MM/DD/YYYY")
  currency              String   @default("USD")

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CompanySettings {
  id                    String   @id @default(cuid())

  // Company info
  companyName           String   @default("Gem Auto Rentals")
  companyEmail          String?
  companyPhone          String?
  companyAddress        String?
  companyLogo           String?

  // Business settings
  defaultCurrency       String   @default("USD")
  defaultTimezone       String   @default("America/New_York")
  taxRate               Decimal  @default(0) @db.Decimal(5, 4)

  // Booking settings
  minBookingHours       Int      @default(24)
  maxBookingDays        Int      @default(30)
  cancellationHours     Int      @default(24)
  depositPercentage     Decimal  @default(0.20) @db.Decimal(3, 2)

  // Operating hours (JSON)
  operatingHours        Json?

  // Terms & policies
  termsOfService        String?  @db.Text
  privacyPolicy         String?  @db.Text
  cancellationPolicy    String?  @db.Text

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model Invoice {
  id              String        @id @default(cuid())

  // Related entities
  bookingId       String?
  booking         Booking?      @relation(fields: [bookingId], references: [id])

  customerId      String
  customer        User          @relation(fields: [customerId], references: [id])

  // Invoice details
  invoiceNumber   String        @unique
  status          InvoiceStatus @default(DRAFT)

  // Amounts
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  discountAmount  Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(10, 2)

  // Line items (JSON array)
  lineItems       Json

  // Dates
  issueDate       DateTime      @default(now())
  dueDate         DateTime
  paidAt          DateTime?

  // Payment
  paymentId       String?

  // PDF
  pdfUrl          String?

  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([customerId])
  @@index([bookingId])
  @@index([status])
  @@index([invoiceNumber])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// Phase 4: Notification System
// ----------------------------

model Notification {
  id            String              @id @default(cuid())

  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type          NotificationType
  title         String
  message       String

  // Related entity
  entityType    String?
  entityId      String?
  actionUrl     String?

  // Delivery status
  channels      NotificationChannel[]
  emailSent     Boolean             @default(false)
  emailSentAt   DateTime?
  smsSent       Boolean             @default(false)
  smsSentAt     DateTime?

  // Read status
  readAt        DateTime?

  createdAt     DateTime            @default(now())

  @@index([userId])
  @@index([type])
  @@index([readAt])
  @@index([createdAt])
}

enum NotificationType {
  // Bookings
  BOOKING_CONFIRMED
  BOOKING_REMINDER
  BOOKING_STARTED
  BOOKING_ENDING_SOON
  BOOKING_COMPLETED
  BOOKING_CANCELLED

  // Payments
  PAYMENT_RECEIVED
  PAYMENT_FAILED
  PAYMENT_REFUNDED
  INVOICE_SENT
  INVOICE_OVERDUE

  // Documents
  DOCUMENT_VERIFIED
  DOCUMENT_REJECTED
  DOCUMENT_EXPIRING

  // Messages
  NEW_MESSAGE
  CONVERSATION_ASSIGNED

  // System
  SYSTEM_ANNOUNCEMENT
  MAINTENANCE_ALERT
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

// Phase 5: External Integrations
// ------------------------------

model Integration {
  id              String              @id @default(cuid())

  // Integration type
  provider        IntegrationProvider @unique

  // Status
  isEnabled       Boolean             @default(false)
  isConnected     Boolean             @default(false)

  // OAuth tokens (encrypted)
  accessToken     String?
  refreshToken    String?
  tokenExpiresAt  DateTime?

  // Provider-specific config
  config          Json?

  // Metadata
  connectedAt     DateTime?
  lastSyncAt      DateTime?
  lastError       String?

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

enum IntegrationProvider {
  STRIPE
  PAYPAL
  MAILCHIMP
  TWILIO
  GOOGLE_CALENDAR
  QUICKBOOKS
  ZAPIER
}

model WebhookLog {
  id              String              @id @default(cuid())

  provider        IntegrationProvider

  // Request details
  eventType       String
  payload         Json

  // Processing
  status          WebhookStatus       @default(PENDING)
  processedAt     DateTime?
  errorMessage    String?
  retryCount      Int                 @default(0)

  createdAt       DateTime            @default(now())

  @@index([provider])
  @@index([status])
  @@index([createdAt])
}

enum WebhookStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

// Update Booking model to add Invoice relation
// (Added at bottom to maintain relation)
